# 关注部分详细说明

本说明文档详细分析本项目后端关于用户关注相关功能的实现机制，涵盖通信流程、文件间交互、前后端链接、全局异常处理以及ApiResponse统一格式、各层次之间的功能与通信过程。内容参考了《博客文章部分详细说明》《用户资料部分详细说明》《登录注册部分详细说明》，并结合实际代码实现。

---

## 1. 通信流程与前后端链接

### 1.1 关注用户流程
- **前端**向`/api/follow/{targetId}`发送POST请求，路径参数为目标用户ID。
- **后端**`FollowController`接收请求，解析当前用户，调用`FollowService.follow(me, target)`执行业务。
- 成功返回`ApiResponse<Void>`，code为200，msg为“关注成功”；失败返回相应错误码和提示。

### 1.2 取关用户流程
- **前端**向`/api/follow/{targetId}`发送DELETE请求。
- **后端**`FollowController`接收请求，调用`FollowService.unfollow(me, target)`。
- 成功返回`ApiResponse<Void>`，code为200，msg为“取关成功”。

### 1.3 获取粉丝/关注列表流程
- **前端**向`/api/follow/followers`或`/api/follow/following`发送GET请求。
- **后端**`FollowController`调用`FollowService.listFollowers(me)`或`listFollowing(me)`。
- 返回`ApiResponse<List<User>>`，code为200，msg为“获取成功”。

### 1.4 判断互相关注流程
- **前端**向`/api/follow/friends/{otherId}`发送GET请求。
- **后端**`FollowController`调用`FollowService.areFriends(me, other)`。
- 返回`ApiResponse<Boolean>`，code为200。

---

## 2. 文件间交互与各层功能

### 2.1 Controller层
- 负责接收前端请求、参数校验、调用Service层、返回统一响应。
- 主要文件：`FollowController.java`
  - 负责`/api/follow`相关接口的路由与响应。

### 2.2 Service层
- 负责关注、取关、查询粉丝/关注、互关等业务逻辑。
- 主要文件：`FollowService.java`、`FollowServiceImpl.java`
  - `follow(follower, followee)`：关注用户，幂等处理。
  - `unfollow(follower, followee)`：取关用户。
  - `listFollowers(user)`：获取粉丝列表。
  - `listFollowing(user)`：获取关注列表。
  - `areFriends(a, b)`：判断互相关注。

### 2.3 Repository层
- 负责关注关系的数据持久化与查询。
- 主要文件：`FollowRepository.java`
  - `findByFollowerAndFollowee`：查找关注关系。
  - `findByFollower`、`findByFollowee`：查找粉丝/关注列表。

### 2.4 Model/DTO/Mapper层
- **Model**：`Follow.java`，关注关系实体，唯一约束防止重复关注。
- **DTO**：`FollowDTO.java`，用于数据传输。
- **Mapper**：`FollowMapper.java`，实现实体与DTO互转，避免实体泄漏。

### 2.5 Common层
- 提供统一响应、异常处理等通用功能。
- 主要文件：`ApiResponse.java`、`BusinessException.java`、`GlobalExceptionHandler.java`

---

## 3. 统一API响应格式（ApiResponse）

- 所有接口返回`ApiResponse<T>`对象，包含：
  - `code`：状态码（如200、400、404等）
  - `msg`：提示信息
  - `data`：数据内容（如用户列表、布尔值等，操作无数据则为null）
- 便于前端统一处理响应。

---

## 4. 全局异常处理

- `GlobalExceptionHandler`统一处理参数校验异常、业务异常、未知异常。
- 参数校验失败时，自动返回400和详细错误信息。
- 业务异常（如重复关注、关注自己、用户不存在等）抛出`BusinessException`，由全局异常处理器捕获并返回友好提示。
- 未知异常返回500和通用错误信息，避免泄露敏感信息。

---

## 5. 各层通信与流程图解

1. **前端**发起关注/取关/查询请求
2. **Controller**接收请求，参数校验
3. **Service**执行业务逻辑（如查库、保存、删除）
4. **DTO/Mapper**用于数据传递与转换
5. **Repository**负责数据库操作
6. **Common**层提供工具与统一响应
7. **异常**由全局处理器统一捕获
8. **Controller**返回统一格式响应给前端

---

## 6. 形象说明

- **关注流程**：
  1. 前端点击“关注”按钮
  2. 后端校验用户、目标用户，查重，保存关注关系
  3. 返回成功或失败提示

- **取关流程**：
  1. 前端点击“取关”按钮
  2. 后端查找并删除关注关系
  3. 返回操作结果

- **粉丝/关注列表**：
  1. 前端请求列表
  2. 后端查找所有相关用户
  3. 返回用户列表

- **异常处理**：
  - 重复关注、关注自己、目标用户不存在等均有详细提示，前端可友好展示

- **统一响应**：
  - 所有接口返回结构一致，便于前端统一处理

---

## 7. 关键代码片段举例

- **ApiResponse**
```java
public class ApiResponse<T> {
    private int code;
    private String msg;
    private T data;
    // ...getter/setter...
}
```

- **全局异常处理**
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(BusinessException.class)
    public ApiResponse<Void> handleBusinessException(BusinessException ex) {
        return new ApiResponse<>(400, ex.getMessage(), null);
    }
    // ...其他异常处理...
}
```

---

## 8. 后续可扩展方向

- 支持分页获取粉丝/关注列表
- 支持关注通知、推荐关注等社交功能
- 关注关系可扩展为分组、备注等
- 支持批量关注、取消关注等高级操作

---

## 9. 前后端通信数据格式示例

### 9.1 关注用户
- **请求**：
  - 方法：POST
  - 路径：/api/follow/{targetId}
  - 请求体：无（用户身份通过登录态或请求头传递）
- **响应**：
```json
{
  "code": 200,
  "msg": "关注成功",
  "data": null
}
```

### 9.2 取关用户
- **请求**：
  - 方法：DELETE
  - 路径：/api/follow/{targetId}
  - 请求体：无
- **响应**：
```json
{
  "code": 200,
  "msg": "取关成功",
  "data": null
}
```

### 9.3 获取粉丝列表
- **请求**：
  - 方法：GET
  - 路径：/api/follow/followers
- **响应**：
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": [
    {
      "id": 2,
      "username": "user2",
      "gender": "男"
    },
    {
      "id": 3,
      "username": "user3",
      "gender": "女"
    }
  ]
}
```

### 9.4 获取关注列表
- **请求**：
  - 方法：GET
  - 路径：/api/follow/following
- **响应**：
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": [
    {
      "id": 4,
      "username": "user4",
      "gender": "保密"
    }
  ]
}
```

### 9.5 判断互相关注
- **请求**：
  - 方法：GET
  - 路径：/api/follow/friends/{otherId}
- **响应**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": true
}
```
